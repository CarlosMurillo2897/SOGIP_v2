@model SOGIP_v2.Models.Archivo
@{
    ViewBag.Title = "Codigos";

}
<link rel="stylesheet" type="text/css" href="~/Content/DataTables/css/jquery.dataTables.css">
<link rel="stylesheet" type="text/css" href="~/Content/DataTables/css/select.dataTables.min.css">
<div class="container">
    <a class='btn btn-success pull-right' style='padding: 2px 6px; margin: 2px;' id="btnNuevo">
        <text class='hidden-xs'>Nuevo </text>
        <span style='color: white;' class='glyphicon glyphicon-plus-sign'></span>
    </a>
    <div id="nuevo" class="modal fade" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" id="cerrar">&times;</button>
                    <h4 class="modal-title">Crear nueva Codigo QR</h4>
                    <br>
                    <label id="label" style="display: none;">Url de Máquina: </label>
                    <label id="label2" style="display: none;">Url de Ejercicio: </label>
                    <input style="display: none;" type="text" class="form-control" placeholder="Url" id="obj" />
                </div>
                <div class="modal-body">
                    <div class="row" id="infouser">
                        <div class="form-group col-lg-6 col-md-6 col-sm-6">
                            <div>
                                <label id="maq"><input type="radio" name="btnRadio" checked />Maquina </label>
                                <label id="usu"><input type="radio" name="btnRadio" />Usuario </label>
                                <label id="ejer"><input type="radio" name="btnRadio" />Ejercicio </label>
                            </div>
                            <input type="text" class="form-control" id="usuario" name="usuario" placeholder="Seleccione un usuario de la tabla." readonly />
                        </div>
                        <div class="form-group col-lg-3 col-md-6 col-sm-6">
                            <button id="botón" type="button" class="btn btn-warning btn-block">
                                <text id="texto">Seleccionar usuario</text>
                                <span id="icono" class="glyphicon glyphicon-search"></span>
                            </button>
                        </div>
                    </div>
                    <hr />
                    <div class="table-responsive" id="Tabla_Usuarios" hidden>
                        <table id="example" class="display table table-bordered table-hover table-striped" style="width:100%">
                            <thead>
                                <tr>
                                    <td>Acción</td>
                                    <td>Nombre</td>
                                    <td>Id</td>
                                </tr>
                            </thead>
                        </table>
                    </div>
                    <div class="modal-footer">
                        <br />
                        <button type="button" id="btnSave" class="btn btn-success">Guardar Cambios</button>
                        <button type="button" class="btn btn-danger" id="cerrar1">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div>
        <label id="maq1"><input type="radio" name="btnRadio1" checked />Maquina </label>
        <label id="usu1"><input type="radio" name="btnRadio1" />Usuario </label>
        <label id="ejer1"><input type="radio" name="btnRadio1" />Ejercico </label>
    </div>
    <div class="well col-md-12">
        <div class="table-responsive">
            <table id="archivos" class="table table-striped table-bordered dt-responsive" style="width: 100%;">
                <thead>
                    <tr>
                        <th>Nombre</th>
                        <th>Tipo</th>
                        <th>
                            <text class="hidden-xs">Acción</text>
                            <span class="glyphicon glyphicon-cog"></span>
                        </th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

    @if (ViewBag.imageBytes != null)
    {
        <img src="@String.Format("data:image/png;base64,{0}", Convert.ToBase64String(ViewBag.imageBytes))" />
    }
    <div>
        <img src="" id="one">
    </div>
</div>
@section Scripts {
    <script type="text/javascript" charset="utf8" src="~/Scripts/DataTables/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="~/Scripts/DataTables/dataTables.select.min.js"></script>
    @Scripts.Render("~/bundles/jqueryval")

    <script>
        function eliminar() {
            var des = $('#example').DataTable();
            des.destroy();
        }
        function eliminar2() {
            var des = $('#archivos').DataTable();
            des.destroy();
        }
        function llenarTablaUsuarios() {
            $('#archivos').DataTable({
                "language": {
                    "lengthMenu": "Mostrando _MENU_ resultados por página.",
                    "zeroRecords": "No se han encontrado registros.",
                    "info": "Mostrando _START_ de _END_, de un total de _TOTAL_ registros.",
                    "infoEmpty": "No hay datos para mostrar",
                    "infoFiltered": "(filtrado de _MAX_ datos obtenidos).",
                    "search": "Filtrar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "ajax": {
                    "url": "/CodigoQR/ObtenerUsuarios",
                    "type": "GET",
                    "dataSrc": "",
                },
                columns: [
                    { data: "Nombre" },
                    { data: "Tipo" },
                    {
                        data: "Id",
                        "render": function (data, type, row) {
                            var Id = row.Id;
                            var action = '';
                            if (row.Nombre.split(' ')[0] === '000000000' && row.Tipo === 'INGRESO MASIVO') {
                                Id = 0;
                            }
                            return "<a class='btn btn-danger' id='boton_" + row.Id + "' onclick='EliminarArchivo(" + Id + ")' style='padding: 2px 6px; margin: 2px;'>" +
                                "<text class='hidden-xs'>Eliminar </text>" +
                                "<span class='glyphicon glyphicon-minus-sign'></span>" +
                                "</a>" +
                                "<a class='btn btn-info' href='/UsersAdmin/Download?archivoId=" + row.Id + "' style='padding: 2px 6px; margin: 2px;'>" +
                                "<text class='hidden-xs'>Descargar </text>" +
                                "<span class='glyphicon glyphicon-download'></span>" +
                                "</a>";
                        }
                    }
                ]
            });
        }
        function llenarTablaMaquinas() {
            $('#archivos').DataTable({
                "language": {
                    "lengthMenu": "Mostrando _MENU_ resultados por página.",
                    "zeroRecords": "No se han encontrado registros.",
                    "info": "Mostrando _START_ de _END_, de un total de _TOTAL_ registros.",
                    "infoEmpty": "No hay datos para mostrar",
                    "infoFiltered": "(filtrado de _MAX_ datos obtenidos).",
                    "search": "Filtrar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "ajax": {
                    "url": "/CodigoQR/ObtenerMaquinas",
                    "type": "GET",
                    "dataSrc": "",
                },
                columns: [
                    { data: "Nombre" },
                    { data: "Tipo" },
                    {
                        data: "Id",
                        "render": function (data, type, row) {
                            var Id = row.Id;
                            var action = '';
                            if (row.Nombre.split(' ')[0] === '000000000' && row.Tipo === 'INGRESO MASIVO') {
                                Id = 0;
                            }
                            return "<a class='btn btn-danger' id='boton_" + row.Id + "' onclick='EliminarArchivo(" + Id + ")' style='padding: 2px 6px; margin: 2px;'>" +
                                "<text class='hidden-xs'>Eliminar </text>" +
                                "<span class='glyphicon glyphicon-minus-sign'></span>" +
                                "</a>" +
                                "<a class='btn btn-info' href='/UsersAdmin/Download?archivoId=" + row.Id + "' style='padding: 2px 6px; margin: 2px;'>" +
                                "<text class='hidden-xs'>Descargar </text>" +
                                "<span class='glyphicon glyphicon-download'></span>" +
                                "</a>";
                        }
                    }
                ]
            });
        }
        function llenarTablaEjercicio() {
            $('#archivos').DataTable({
                "language": {
                    "lengthMenu": "Mostrando _MENU_ resultados por página.",
                    "zeroRecords": "No se han encontrado registros.",
                    "info": "Mostrando _START_ de _END_, de un total de _TOTAL_ registros.",
                    "infoEmpty": "No hay datos para mostrar",
                    "infoFiltered": "(filtrado de _MAX_ datos obtenidos).",
                    "search": "Filtrar:",
                    "paginate": {
                        "first": "Primero",
                        "last": "Ultimo",
                        "next": "Siguiente",
                        "previous": "Anterior"
                    }
                },
                "ajax": {
                    "url": "/CodigoQR/ObtenerEjercicio",
                    "type": "GET",
                    "dataSrc": "",
                },
                columns: [
                    { data: "Nombre" },
                    { data: "Tipo" },
                    {
                        data: "Id",
                        "render": function (data, type, row) {
                            var Id = row.Id;
                            var action = '';
                            if (row.Nombre.split(' ')[0] === '000000000' && row.Tipo === 'INGRESO MASIVO') {
                                Id = 0;
                            }
                            return "<a class='btn btn-danger' id='boton_" + row.Id + "' onclick='EliminarDes(" + Id + ")' style='padding: 2px 6px; margin: 2px;'>" +
                                "<text class='hidden-xs'>Eliminar </text>" +
                                "<span class='glyphicon glyphicon-minus-sign'></span>" +
                                "</a>" +
                                "<a class='btn btn-info' href='/UsersAdmin/Download?archivoId=" + row.Id + "' style='padding: 2px 6px; margin: 2px;'>" +
                                "<text class='hidden-xs'>Ver </text>" +
                                "<span class='glyphicon glyphicon-sd-video'></span>" +
                                "</a>";
                        }
                    }
                ]
            });
        } function EliminarDes(id) {
            var tr = $('#boton_' + id).closest('tr');
            if (id === 0) {
                alert('Archivo predeterminado, no se puede borrar.');
                return;
            }

            $.ajax({
                type: "POST",
                url: "/CodigoQR/EliminarEjer",
                data: { id: id },
                success: function (data) {
                    var table = $('#archivos').DataTable().row(tr).remove().draw();
                },
                error: function (data) {
                    alert("¡Error!");
                }
            });
        }
        function EliminarArchivo(id) {
            var tr = $('#boton_' + id).closest('tr');
            if (id === 0) {
                alert('Archivo predeterminado, no se puede borrar.');
                return;
            }

            $.ajax({
                type: "POST",
                url: "/CodigoQR/EliminarArchivo",
                data: { id: id },
                success: function (data) {
                    var table = $('#archivos').DataTable().row(tr).remove().draw();
                },
                error: function (data) {
                    alert("¡Error!");
                }
            });
        }
        $(document).ready(function () {
            llenarTablaMaquinas();
            var ced = null;
            $('#usu1').click(function () {
                eliminar2();
                llenarTablaUsuarios();
            })
            $('#maq1').click(function () {
                eliminar2();
                llenarTablaMaquinas();
            })
            $('#ejer1').click(function () {
                eliminar2();
                llenarTablaEjercicio();
            })

            $('#btnNuevo').click(function () {
                $('#nuevo').modal('show');
                $('#label').css("display", "block");
                $('#obj').css("display", "block");
                maquinas();
                $('#usu').click(function () {
                    $('#label').css("display", "none");
                    $('#label2').css("display", "none");
                    $('#obj').css("display", "none");
                    eliminar();
                    usuarios();
                })
                $('#maq').click(function () {
                    $('#label').css("display", "block");
                    $('#label2').css("display", "none");
                    $('#obj').css("display", "block");
                    eliminar();
                    maquinas();
                })
                $('#ejer').click(function () {
                    $('#label2').css("display", "block");
                    $('#label').css("display", "none");
                    $('#obj').css("display", "block");
                    eliminar();
                    ejercicios();

                })

            })
         
            $('#btnSave').click(function () {
                var data = null;
                if ($('#label').is(':visible')) { 
                    data = {
                        txtQRCode: $('#obj').val().trim(),
                        id: ced
                    }
                    generarQR(data);
                } else {
                    if ($('#label2').is(':visible')) {
                        data = {
                            txtQRCode: $('#obj').val().trim(),
                            id: ced
                        }
                        generarEjercicio(data);
                    } else {
                        data = { 
                            id: ced
                        }
                        generarQR2(data);
                    }
                }
            })
            function generarQR(data) {
                $.ajax({
                    type: "POST",
                    dataType: "JSON",
                    url: '/CodigoQR/generarQr',
                    data: data,
                    success: function (data) {
                        $('#archivos').DataTable().ajax.reload(null, false);
                        $('#nuevo').modal('hide');
                        $('#obj').val('');
                        eliminar();
                    },
                    error: function () {
                        alert("Fallo");
                    }
                })
            }
            function generarQR2(data) {
                $.ajax({
                    type: "POST",
                    dataType: "JSON",
                    url: '/CodigoQR/generarQr2',
                    data: data,
                    success: function (data) {
                        $('#archivos').DataTable().ajax.reload(null, false);
                        $('#nuevo').modal('hide');
                        $('#obj').val('');
                        eliminar();
                    },
                    error: function () {
                        alert("Fallo");
                    }
                })
            }
            function generarEjercicio(data) {
                $.ajax({
                    type: "POST",
                    dataType: "JSON",
                    url: '/CodigoQR/generarEjercicio',
                    data: data,
                    success: function (data) {
                        $('#archivos').DataTable().ajax.reload(null, false);
                        $('#nuevo').modal('hide');
                        $('#obj').val('');
                        eliminar();
                    },
                    error: function () {
                        alert("Fallo");
                    }
                })
            }
            function maquinas() {
                $('#example').DataTable({
                    "language": {
                        "lengthMenu": "Mostrando _MENU_ resultados por página.",
                        "zeroRecords": "No se han encontrado registros.",
                        "info": "Mostrando página _PAGE_ de _PAGES_.",
                        "infoEmpty": "No hay datos para mostrar",
                        "infoFiltered": "(filtrado de _MAX_ datos obtenidos).",
                        "search": "Filtrar:",
                        "paginate": {
                            "first": "Primero",
                            "last": "Ultimo",
                            "next": "Siguiente",
                            "previous": "Anterior"
                        }
                    },
                    "ajax": {
                        "url": '/CodigoQR/GetMaquinas2',
                        "type": "GET",
                        "dataSrc": ""
                    },
                    columns: [
                        { data: "Accion" },
                        { data: "Nombre" },
                        { data: "Id" },
                    ],
                    'columnDefs': [
                        {
                            orderable: false,
                            className: 'select-checkbox',
                            targets: [0]
                        }
                    ],
                    'select': {
                        'style': 'os',
                        'selector': 'td:first-child'

                    }
                });
            }
            function usuarios() {
                $('#example').DataTable({
                    "language": {
                        "lengthMenu": "Mostrando _MENU_ resultados por página.",
                        "zeroRecords": "No se han encontrado registros.",
                        "info": "Mostrando página _PAGE_ de _PAGES_.",
                        "infoEmpty": "No hay datos para mostrar",
                        "infoFiltered": "(filtrado de _MAX_ datos obtenidos).",
                        "search": "Filtrar:",
                        "paginate": {
                            "first": "Primero",
                            "last": "Ultimo",
                            "next": "Siguiente",
                            "previous": "Anterior"
                        }
                    },
                    "ajax": {
                        "url": '/CodigoQR/GetUsuarios2',
                        "type": "GET",
                        "dataSrc": ""
                    },
                    columns: [
                        { data: "Accion" },
                        { data: "Nombre" },
                        { data: "Id" },
                    ],
                    'columnDefs': [
                        {
                            orderable: false,
                            className: 'select-checkbox',
                            targets: [0]
                        }
                    ],
                    'select': {
                        'style': 'os',
                        'selector': 'td:first-child'

                    }
                });
            }
            function ejercicios() {
                $('#example').DataTable({
                    "language": {
                        "lengthMenu": "Mostrando _MENU_ resultados por página.",
                        "zeroRecords": "No se han encontrado registros.",
                        "info": "Mostrando página _PAGE_ de _PAGES_.",
                        "infoEmpty": "No hay datos para mostrar",
                        "infoFiltered": "(filtrado de _MAX_ datos obtenidos).",
                        "search": "Filtrar:",
                        "paginate": {
                            "first": "Primero",
                            "last": "Ultimo",
                            "next": "Siguiente",
                            "previous": "Anterior"
                        }
                    },
                    "ajax": {
                        "url": '/CodigoQR/GetMaquinas3',
                        "type": "GET",
                        "dataSrc": ""
                    },
                    columns: [
                        { data: "Accion" },
                        { data: "Nombre" },
                        { data: "Id" },
                    ],
                    'columnDefs': [
                        {
                            orderable: false,
                            className: 'select-checkbox',
                            targets: [0]
                        }
                    ],
                    'select': {
                        'style': 'os',
                        'selector': 'td:first-child'

                    }
                });
            }
            $('#cerrar').click(function () {
                eliminar();
                $('#nuevo').modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            })
            $('#cerrar1').click(function () {
                eliminar();
                $('#nuevo').modal('hide');
                $('body').removeClass('modal-open');
                $('.modal-backdrop').remove();
            })
            $('#botón').click(function () {
                $('#Tabla_Usuarios').show();

            });
            $('#example').on('click', 'td.select-checkbox', function () {
                var td = $(this);
                var tr = td.closest('tr');

                $('#usuario').val(tr.find('td:eq(1)').text());
                ced = tr.find('td:eq(2)').text();
                $('#Tabla_Usuarios').hide();
            });

        });
    </script>
}
